From eaa8ecccb7de1ec98fd8dba63b0d3fc1153edc0e Mon Sep 17 00:00:00 2001
From: Andrey Ni <ni.andrey@gmail.com>
Date: Fri, 17 Dec 2021 17:21:11 +0600
Subject: [PATCH] cve-hotfix

---
 src/core/nginx.h        | 2 +-
 src/core/ngx_resolver.c | 7 +++----
 2 files changed, 4 insertions(+), 5 deletions(-)

diff --git a/src/core/nginx.h b/src/core/nginx.h
index ad1a3b2b..ab09ab1e 100644
--- a/src/core/nginx.h
+++ b/src/core/nginx.h
@@ -10,7 +10,7 @@
 
 
 #define nginx_version      1015010
-#define NGINX_VERSION      "1.15.10"
+#define NGINX_VERSION      "1.15.10-CVE-2021-23017"
 #define NGINX_VER          "nginx/" NGINX_VERSION
 
 #ifdef NGX_BUILD
diff --git a/src/core/ngx_resolver.c b/src/core/ngx_resolver.c
index 593645d5..c0d8d96d 100644
--- a/src/core/ngx_resolver.c
+++ b/src/core/ngx_resolver.c
@@ -3992,15 +3992,14 @@ done:
             n = *src++;
 
         } else {
+            if (dst != name->data) {
+                *dst++ = '.';
+            }
             ngx_strlow(dst, src, n);
             dst += n;
             src += n;
 
             n = *src++;
-
-            if (n != 0) {
-                *dst++ = '.';
-            }
         }
 
         if (n == 0) {
-- 
2.33.1.windows.1

